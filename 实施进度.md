# 实施进度

## 已完成的更改
- 新增 4 张表的模型结构（Beego ORM）
  - `models/daily_scan.go`
  - `models/daily_features.go`
  - `models/feature_timeseries.go`
  - `models/backtest_t1.go`
- 注册新模型并创建索引
  - `main.go`：注册 4 个模型 + 启动每日扫描调度
  - `models/migrate.go`：新增 `EnsureDailyScanSchema()`，创建唯一索引与查询索引
- 新增行情 API 封装
  - `feature/api/binance/index.go`：新增 `Get24hPriceChangeStats` 与 `GetBasis`
- 新增每日扫描与回测核心流程
  - `feature/feature_scan.go`：调度器、榜单筛选、特征采集、T+1 回测、并发采集
  - 加入统一重试与退避（`retry_max`、`retry_backoff_ms`）
- 加入全局 REST 频控与封禁保护
  - `feature/api/binance/limiter.go`：统一限速、解析 ban until、自动等待解除
  - `feature/api/binance/index.go`：所有 REST 调用接入 `withLimiter(...)`
- 降低扫描突发
  - `feature/feature_scan.go`：新增 `request_gap_ms`（扫描请求间隔）
- 配置文件新增扫描参数并启用
  - `conf/app.conf`：新增并启用 `[scan]` 段（默认 enabled=1）
  - `conf/app.conf.example`：新增 `[scan]` 段与重试参数
  - `conf/app.conf` / `conf/app.conf.example`：新增 `binance::rate_limit_per_min` 与 `scan::request_gap_ms`

## 已实现的功能点
- 每日 UTC 00:05 调度执行
- 24h 榜单筛选（TopN + quoteVolume 过滤 + 仅 USDT PERPETUAL）
- 写入 `daily_scan`
- 写入 `daily_features`（资金费率/标记价/开仓量等快照）
- 写入 `feature_timeseries`（OI、资金费率、多空比、taker、basis）
- T+1 回测（Kline 1d，计算次日收益并写入 `backtest_t1`）

## 如何测试
1) 确认 `conf/app.conf` 中 `[scan]` enabled=1
2) 启动服务
3) 观察日志是否有 `daily scan start: YYYY-MM-DD`
4) 检查数据库表是否创建并写入：
   - `daily_scan`
   - `daily_features`
   - `feature_timeseries`
   - `backtest_t1`
5) 若需手动触发：可临时在 `main.go` 中直接调用 `RunDailyScanPipeline(...)`（尚未提供 CLI）
6) 观察日志中是否还出现 `code=-1003` 或 `banned until`（应明显减少）

## 进度状态
- 当前阶段：核心扫描 + 回测流程已落地，支持自动调度；已加入全局限速与 ban 保护
- 风险点：请求量仍受 TopN/并发/频率影响，必要时进一步调低 `max_workers` 或上调 `request_gap_ms`

## 仍未完成 / 待做
- 手动触发入口（CLI 或 HTTP 管理入口）
- 失败/缺失统计报表输出
- 更精细的日志聚合与异常告警
- 更严格的“日K闭合”校验（若当天 Kline 未返回）
