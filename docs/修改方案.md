
• 下面是最终方案（保留四张表），按你的目标落地，同时吸收“流动性过
  滤”“T+1 用日K”的关键修正点。全方案只给设计与流程，不改代码。

  一、核心原则（不会踩坑）

  - 榜单来源是 24h 滚动窗口，不是自然日，所以仅用于“榜单筛选”；回测必须
    用日K（UTC 日线）计算 T+1。(developers.binance.com (https://
    developers.binance.com/docs/zh-CN/derivatives/usds-margined-
    futures/market-data/rest-api/24hr-Ticker-Price-Change-Statistics?
    utm_source=openai))
  - 强制流动性过滤：quoteVolume ≥ 50,000,000 USDT，避免土狗噪音（24h
    ticker 给到 quoteVolume）。(developers.binance.com (https://
    developers.binance.com/docs/zh-CN/derivatives/usds-margined-
    futures/market-data/rest-api/24hr-Ticker-Price-Change-Statistics?
    utm_source=openai))
  - 所有日级数据统一 UTC 时间切片，每天固定时间执行（建议 UTC 00:05 之
    后），避免日K未完整。(developers.binance.com (https://
    developers.binance.com/docs/zh-CN/derivatives/usds-margined-
    futures/market-data/rest-api/Kline-Candlestick-Data?
    utm_source=openai))
  - 只做 U 本位衍生品（USDT‑M Futures）：所有接口都在 /fapi 与 /
    futures/data。(developers.binance.com (https://
    developers.binance.com/docs/zh-CN/derivatives/usds-margined-
    futures/market-data/rest-api/24hr-Ticker-Price-Change-Statistics?
    utm_source=openai))

  ———

  ## 二、模块拆分（职责清晰）

  1. Daily Scan
      - 拉全量 24hr ticker（权重 40），按 priceChangePercent 排序取
        Top10 涨/跌。(developers.binance.com (https://
        developers.binance.com/docs/zh-CN/derivatives/usds-margined-
        futures/market-data/rest-api/24hr-Ticker-Price-Change-
        Statistics?utm_source=openai))
      - 用 exchangeInfo 过滤交易状态、只保留 USDT 永续（PERPETUAL）。
        (developers.binance.com (https://developers.binance.com/docs/
        zh-CN/derivatives/usds-margined-futures/market-data/rest-api/
        Exchange-Information?utm_source=openai))
      - 用 quoteVolume >= 50,000,000 过滤流动性。
  2. Feature Extraction
      - 对入榜 symbol 批量拉取“微观数据 + 结构性数据”。
      - 所有数据以 当日快照 方式写入（snapshot），历史时间序列进
        feature_timeseries。
  3. Persistence
      - 四张表（见后文），每日幂等写入，避免重复扫描。
  4. T+1 Backtest
      - 用 日K 1d 计算 T+1（close/open - 1）。(developers.binance.com
        (https://developers.binance.com/docs/zh-CN/derivatives/usds-
        margined-futures/market-data/rest-api/Kline-Candlestick-Data?
        utm_source=openai))

  ———

  ## 三、四张表结构（最终版）

  ### 1) daily_scan（每日榜单）

  用途：记录当日入榜币种（涨/跌 Top10）
  关键字段

  - scan_date (UTC date)
  - symbol
  - direction (gain/lose)
  - rank
  - priceChangePercent (来自 24h ticker)
  - quoteVolume
  - openTime closeTime（24h窗口时间戳）

  ### 2) daily_features（当日特征快照）

  用途：存“当日时点”的核心指标
  字段（建议）：

  - scan_date, symbol
  - markPrice, indexPrice, lastFundingRate, nextFundingTime
    (premiumIndex)(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Mark-Price?utm_source=openai))
  - openInterest (openInterest)(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Open-Interest?utm_source=openai))
  - topLongShortPositionRatio (topLongShortPositionRatio)
    (developers.binance.com (https://developers.binance.com/docs/
    derivatives/usds-margined-futures/market-data/rest-api/Top-Trader-
    Long-Short-Ratio?utm_source=openai))
  - topLongShortAccountRatio (topLongShortAccountRatio)
    (developers.binance.com (https://developers.binance.com/docs/
    derivatives/usds-margined-futures/market-data/rest-api/Top-Long-
    Short-Account-Ratio?utm_source=openai))
  - globalLongShortRatio (globalLongShortAccountRatio)
    (developers.binance.com (https://developers.binance.com/docs/
    derivatives/usds-margined-futures/market-data/rest-api/Long-Short-
    Ratio?utm_source=openai))
  - takerBuySellRatio (takerlongshortRatio)(developers.binance.com
    (https://developers.binance.com/docs/derivatives/usds-margined-
    futures/market-data/rest-api/Taker-BuySell-Volume?
    utm_source=openai))
  - basis, annualizedBasisRate, futuresPrice, indexPrice (basis)
    (developers.binance.com (https://developers.binance.com/docs/
    derivatives/usds-margined-futures/market-data/rest-api/Basis?
    utm_source=openai))
  - raw_json（可选，方便回放）

  ### 3) feature_timeseries（30天窗口时序）

  用途：存结构性历史指标，便于计算趋势与斜率
  字段：

  - symbol, metric, timestamp, value, extra_json
    数据来源（都只有最近 30 天）：
  - openInterestHist(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Open-Interest-Statistics?utm_source=openai))
  - topLongShortPositionRatio(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Top-Trader-Long-Short-Ratio?
    utm_source=openai))
  - topLongShortAccountRatio(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Top-Long-Short-Account-Ratio?
    utm_source=openai))
  - globalLongShortAccountRatio(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Long-Short-Ratio?utm_source=openai))
  - takerlongshortRatio(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Taker-BuySell-Volume?utm_source=openai))
  - basis(developers.binance.com (https://developers.binance.com/docs/
    derivatives/usds-margined-futures/market-data/rest-api/Basis?
    utm_source=openai))
  - fundingRate history(developers.binance.com (https://
    developers.binance.com/docs/zh-CN/derivatives/usds-margined-
    futures/market-data/rest-api/Get-Funding-Rate-History?
    utm_source=openai))

  > 这些接口都标明“仅最近 30 天可用”，必须按窗口滚动计算。
  > (developers.binance.com (https://developers.binance.com/docs/
  > derivatives/usds-margined-futures/market-data/rest-api/Open-
  > Interest-Statistics?utm_source=openai))

  ### 4) backtest_t1（次日结果）

  用途：存“昨日上榜币种的 T+1 收益”
  字段：

  - scan_date（昨日）
  - symbol, direction, rank
  - t1_open, t1_close, t1_return
  - 数据来自 fapi/v1/klines 的 1d 日K。(developers.binance.com
    (https://developers.binance.com/docs/zh-CN/derivatives/usds-
    margined-futures/market-data/rest-api/Kline-Candlestick-Data?
    utm_source=openai))

  ———

  ## 四、接口映射表（关键 REST API）

  榜单数据

  - 24h 价格变动统计：/fapi/v1/ticker/24hr（不带 symbol 权重 40）
    (developers.binance.com (https://developers.binance.com/docs/zh-CN/
    derivatives/usds-margined-futures/market-data/rest-api/24hr-Ticker-
    Price-Change-Statistics?utm_source=openai))

  快照特征

  - Mark Price + Funding：/fapi/v1/premiumIndex(developers.binance.com
    (https://developers.binance.com/docs/derivatives/usds-margined-
    futures/market-data/rest-api/Mark-Price?utm_source=openai))
  - Open Interest：/fapi/v1/openInterest(developers.binance.com
    (https://developers.binance.com/docs/derivatives/usds-margined-
    futures/market-data/rest-api/Open-Interest?utm_source=openai))
  - Exchange Info（过滤交易状态/类型）：/fapi/v1/
    exchangeInfo(developers.binance.com (https://
    developers.binance.com/docs/zh-CN/derivatives/usds-margined-
    futures/market-data/rest-api/Exchange-Information?
    utm_source=openai))

  历史特征（30天窗口）

  - OI 历史：/futures/data/openInterestHist(developers.binance.com
    (https://developers.binance.com/docs/derivatives/usds-margined-
    futures/market-data/rest-api/Open-Interest-Statistics?
    utm_source=openai))
  - 大户持仓比：/futures/data/
    topLongShortPositionRatio(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Top-Trader-Long-Short-Ratio?
    utm_source=openai))
  - 大户账户比：/futures/data/
    topLongShortAccountRatio(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Top-Long-Short-Account-Ratio?
    utm_source=openai))
  - 全市场多空比：/futures/data/
    globalLongShortAccountRatio(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Long-Short-Ratio?utm_source=openai))
  - 主动买卖量：/futures/data/
    takerlongshortRatio(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Taker-BuySell-Volume?utm_source=openai))
  - 基差：/futures/data/basis(developers.binance.com (https://
    developers.binance.com/docs/derivatives/usds-margined-futures/
    market-data/rest-api/Basis?utm_source=openai))
  - 资金费率历史：/fapi/v1/fundingRate(developers.binance.com (https://
    developers.binance.com/docs/zh-CN/derivatives/usds-margined-
    futures/market-data/rest-api/Get-Funding-Rate-History?
    utm_source=openai))

  回测

  - 日K：/fapi/v1/klines（1d）(developers.binance.com (https://
    developers.binance.com/docs/zh-CN/derivatives/usds-margined-
    futures/market-data/rest-api/Kline-Candlestick-Data?
    utm_source=openai))

  ———

  ## 五、调度与执行顺序（每日流水线）

  每日 UTC 00:05

  1. 拉取 exchangeInfo（更新可交易 USDT‑PERPETUAL 列表）
     (developers.binance.com (https://developers.binance.com/docs/zh-
     CN/derivatives/usds-margined-futures/market-data/rest-api/
     Exchange-Information?utm_source=openai))
  2. 拉取 24h ticker 全量 → 过滤交易对 + quoteVolume → 取 Top10 涨/跌 →
     写 daily_scan。(developers.binance.com (https://
     developers.binance.com/docs/zh-CN/derivatives/usds-margined-
     futures/market-data/rest-api/24hr-Ticker-Price-Change-Statistics?
     utm_source=openai))
  3. 对 20 个币逐个拉快照特征 → 写 daily_features。
     (developers.binance.com (https://developers.binance.com/docs/
     derivatives/usds-margined-futures/market-data/rest-api/Mark-Price?
     utm_source=openai))
  4. 拉 30 天窗口结构数据 → 写 feature_timeseries。
     (developers.binance.com (https://developers.binance.com/docs/
     derivatives/usds-margined-futures/market-data/rest-api/Open-
     Interest-Statistics?utm_source=openai))
  5. 计算“昨日榜单”的 T+1：用日K（1d）算 close/open - 1 → 写
     backtest_t1。(developers.binance.com (https://
     developers.binance.com/docs/zh-CN/derivatives/usds-margined-
     futures/market-data/rest-api/Kline-Candlestick-Data?
     utm_source=openai))

  ———

  ## 六、并发与限频策略（防封）

  - /fapi/v1/ticker/24hr 不带 symbol 权重 40，一天一次足够。
    (developers.binance.com (https://developers.binance.com/docs/zh-CN/
    derivatives/usds-margined-futures/market-data/rest-api/24hr-Ticker-
    Price-Change-Statistics?utm_source=openai))
  - 历史数据接口（openInterestHist/longShort/taker/basis）均有 “30天限
    制 + IP 1000/5min”提示，需并发控制与重试。(developers.binance.com
    (https://developers.binance.com/docs/derivatives/usds-margined-
    futures/market-data/rest-api/Open-Interest-Statistics?
    utm_source=openai))
  - 建议并发 <= 5，失败指数回退，避免 429/418。

  ———

  ## 七、输出与评估指标

  - 输出报表：scan_date → 特征快照 → t1_return
  - 可扩展指标（基于 timeseries）：
      - OI 斜率、资金费率波动度、多空比变化率、taker 买卖比例趋势
  - 评估维度：涨幅榜 vs 跌幅榜 的 T+1 胜率/收益率差异


• 收到，下面给出最终字段表（精确字段 + 类型 + 索引 + 唯一键），对应你要
  的四张表，并满足：UTC 00:05 执行、quoteVolume ≥ 5000 万过滤、日K回
  测。

  ———

  ## 1) daily_scan（每日榜单）

  用途：记录每天 Top10 涨/跌
  唯一性：同一天同币种只会出现一次

  字段建议（SQLite / GORM 通用）：

  - id INTEGER PK
  - scan_date DATE NOT NULL  (UTC, YYYY‑MM‑DD)
  - symbol TEXT NOT NULL
  - direction TEXT NOT NULL  (gain / lose)
  - rank INTEGER NOT NULL
  - price_change_percent REAL
  - quote_volume REAL
  - open_time INTEGER (ms)
  - close_time INTEGER (ms)
  - created_at DATETIME

  索引/约束：

  - UNIQUE(scan_date, symbol)
  - INDEX(scan_date, direction)
  - INDEX(symbol)

  ———

  ## 2) daily_features（当日特征快照）

  用途：存“当日时点”的核心快照

  字段建议：

  - id INTEGER PK
  - scan_date DATE NOT NULL
  - symbol TEXT NOT NULL

  快照特征字段

  - mark_price REAL
  - index_price REAL
  - last_funding_rate REAL
  - next_funding_time INTEGER (ms)
  - open_interest REAL
  - top_long_short_position_ratio REAL
  - top_long_short_account_ratio REAL
  - global_long_short_ratio REAL
  - taker_buy_sell_ratio REAL
  - basis REAL
  - annualized_basis_rate REAL
  - futures_price REAL
  - funding_rate_interval INTEGER (ms，可选)
  - raw_json TEXT (可选，存整包 JSON)

  索引/约束：

  - UNIQUE(scan_date, symbol)
  - INDEX(symbol)
  - INDEX(scan_date)

  ———

  ## 3) feature_timeseries（特征历史序列）

  用途：存近 30 天时间序列特征，用于趋势/斜率/波动计算

  字段建议：

  - id INTEGER PK
  - symbol TEXT NOT NULL
  - metric TEXT NOT NULL
    （如：open_interest_hist / funding_rate_hist /
    top_long_short_position / taker_ratio / basis 等）
  - timestamp INTEGER NOT NULL (ms)
  - value REAL NOT NULL
  - extra_json TEXT (可选)
  - created_at DATETIME

  索引/约束：

  - UNIQUE(symbol, metric, timestamp)
  - INDEX(symbol, metric)
  - INDEX(timestamp)

  ———

  用途：记录“昨日榜单 → 次日收益”

  字段建议：

  - id INTEGER PK
  - direction TEXT NOT NULL  (gain / lose)
  - rank INTEGER NOT NULL
  - t1_open REAL
  - t1_close REAL
  - t1_return REAL
  - created_at DATETIME

  索引/约束：

  - UNIQUE(scan_date, symbol)
  - INDEX(scan_date)
  - INDEX(symbol)

  ———

  ## 关键计算规则（写入逻辑约束）

  1. 榜单过滤：只保留 quote_volume >= 50,000,000
  2. 回测收益：
      - 使用 1d Kline
      - t1_return = (t1_close / t1_open) - 1
  3. 执行时间：UTC 00:05 以后执行
  4. 幂等写入：对 4 张表均采用 UNIQUE 约束，重复扫描做 upsert

  ———

  如果你确认字段无误，我可以继续给你模块落地清单（目录结构 + 调用链 +
  函数签名），同样不改代码。
  回复“继续”即可。

  ———

  ## 八、模块落地清单（目录结构 + 职责）

  目标：不改现有业务结构，新增最小模块完成每日扫描与回测。

  - models/
      - daily_scan.go：DailyScan 结构体 + 索引标签
      - daily_features.go：DailyFeature 结构体 + 索引标签
      - feature_timeseries.go：FeatureTimeseries 结构体 + 索引标签
      - backtest_t1.go：BacktestT1 结构体 + 索引标签
  - feature/
      - feature_scan.go：每日流水线入口（调度器调用）
      - feature_scan_fetch.go：采集层（调用 Binance API 封装）
      - feature_scan_calc.go：T+1 回测计算
  - feature/api/binance/
      - market_scan.go：U 本位行情 REST 采集封装（集中限频、重试）
  - command/
      - scan_daily.go（可选）：提供 CLI 手动执行一次扫描与回测

  说明：若已有统一的数据库初始化与迁移逻辑，模型文件只需与现有模式保持一致。

  ———

  ## 九、执行流程（调用链）

  1) Scheduler（UTC 00:05）触发 RunDailyPipeline(todayUTC)
  2) 拉 exchangeInfo → 过滤可交易 USDT‑PERPETUAL
  3) 拉 24h ticker 全量 → 过滤 quoteVolume >= 50,000,000 → Top10 涨/跌
  4) Upsert daily_scan
  5) 对 20 个 symbol 并发采集快照 → Upsert daily_features
  6) 拉 30 天窗口历史指标 → Upsert feature_timeseries
  7) 对昨天 scan_date 做 T+1 回测 → Upsert backtest_t1

  ———

  ## 十、函数签名（建议）

  - RunDailyPipeline(ctx, scanDateUTC time.Time) error
  - ScanTopMovers(ctx, scanDateUTC time.Time) (gainers, losers []Ticker24h, err error)
  - FetchSnapshotFeatures(ctx, symbol string) (*DailyFeature, error)
  - FetchTimeseries(ctx, symbol string) ([]FeatureTimeseries, error)
  - BacktestT1(ctx, scanDateUTC time.Time) ([]BacktestT1, error)
  - CalcT1Return(ctx, symbol string, dayUTC time.Time) (open, close, ret float64, err error)

  Binance API 封装层建议：
  - GetExchangeInfo(ctx) ([]SymbolInfo, error)
  - Get24hTickers(ctx) ([]Ticker24h, error)
  - GetPremiumIndex(ctx, symbol) (PremiumIndex, error)
  - GetOpenInterest(ctx, symbol) (OpenInterest, error)
  - GetFundingRateHistory(ctx, symbol, startTime, endTime) ([]FundingRate, error)
  - GetOpenInterestHist(ctx, symbol, period, limit) ([]OpenInterestHist, error)
  - GetTopLongShortPositionRatio(ctx, symbol, period, limit) ([]RatioItem, error)
  - GetTopLongShortAccountRatio(ctx, symbol, period, limit) ([]RatioItem, error)
  - GetGlobalLongShortAccountRatio(ctx, symbol, period, limit) ([]RatioItem, error)
  - GetTakerLongShortRatio(ctx, symbol, period, limit) ([]RatioItem, error)
  - GetBasis(ctx, symbol, period, limit) ([]BasisItem, error)
  - GetKlines(ctx, symbol, interval, startTime, endTime, limit) ([]Kline, error)

  ———

  ## 十一、关键细节（避免逻辑坑）

  - UTC 时间切片：
      - scanDateUTC = 当天 UTC 日期（00:00:00）
      - T+1 回测使用 scanDateUTC+1 的日K（open/close）
  - 交易对过滤：
      - contractType == PERPETUAL
      - status == TRADING
      - quoteAsset == USDT
  - 流动性过滤：
      - quoteVolume >= 50,000,000
  - 幂等写入：
      - 所有表基于 UNIQUE 约束 Upsert（避免重复）
  - 数据缺失：
      - 某接口返回空时允许字段为空，但要记录日志，避免静默失败

  ———

  ## 十二、并发与限频策略（实现建议）

  - 并发控制：建议 worker pool <= 5
  - 失败重试：指数退避 + 随机抖动
  - 429/418：强制降速 + 延迟重试
  - 历史接口（30 天窗口）限制更严，优先使用缓存

  ———

  ## 十三、输出校验与监控建议

  - 每日 scan 数量必须 = 20（10 涨 + 10 跌），不足则报警
  - daily_features 覆盖率 >= 90%（有缺口则输出缺失清单）
  - backtest_t1 覆盖率 >= 90%
  - 每日生成一份简报（scan_date / 平均收益 / 胜率 / 异常接口）

  ———

  ## 十四、GORM 模型字段建议（含索引标签）

  以下为字段示例，仅作结构参考：

  - DailyScan
      - ScanDate     time.Time  `gorm:"type:date;not null;uniqueIndex:uniq_scan_symbol"`
      - Symbol       string     `gorm:"size:20;not null;uniqueIndex:uniq_scan_symbol;index"`
      - Direction    string     `gorm:"size:8;not null;index:idx_scan_direction"`
      - Rank         int        `gorm:"not null"`
      - PriceChangePercent float64
      - QuoteVolume  float64
      - OpenTime     int64
      - CloseTime    int64
      - CreatedAt    time.Time

  - DailyFeature
      - ScanDate     time.Time  `gorm:"type:date;not null;uniqueIndex:uniq_feat_symbol"`
      - Symbol       string     `gorm:"size:20;not null;uniqueIndex:uniq_feat_symbol;index"`
      - MarkPrice    float64
      - IndexPrice   float64
      - LastFundingRate float64
      - NextFundingTime int64
      - OpenInterest float64
      - TopLongShortPositionRatio float64
      - TopLongShortAccountRatio float64
      - GlobalLongShortRatio float64
      - TakerBuySellRatio float64
      - Basis float64
      - AnnualizedBasisRate float64
      - FuturesPrice float64
      - FundingRateInterval int64
      - RawJSON string `gorm:"type:text"`
      - CreatedAt time.Time

  - FeatureTimeseries
      - Symbol    string   `gorm:"size:20;not null;uniqueIndex:uniq_ts;index:idx_ts_metric"`
      - Metric    string   `gorm:"size:64;not null;uniqueIndex:uniq_ts;index:idx_ts_metric"`
      - Timestamp int64    `gorm:"not null;uniqueIndex:uniq_ts;index"`
      - Value     float64  `gorm:"not null"`
      - ExtraJSON string   `gorm:"type:text"`
      - CreatedAt time.Time

  - BacktestT1
      - ScanDate  time.Time `gorm:"type:date;not null;uniqueIndex:uniq_bt_symbol;index"`
      - Symbol    string    `gorm:"size:20;not null;uniqueIndex:uniq_bt_symbol;index"`
      - Direction string    `gorm:"size:8;not null"`
      - Rank      int       `gorm:"not null"`
      - T1Open    float64
      - T1Close   float64
      - T1Return  float64
      - CreatedAt time.Time

  注意：GORM 默认会创建 ID 主键；如需自定义主键可补充 gorm:"primaryKey"。

  ———

  ## 十五、SQLite 迁移草案（可选）

  如果不用 GORM AutoMigrate，可用以下 SQL：

  - daily_scan
      CREATE TABLE IF NOT EXISTS daily_scan (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        scan_date TEXT NOT NULL,
        symbol TEXT NOT NULL,
        direction TEXT NOT NULL,
        rank INTEGER NOT NULL,
        price_change_percent REAL,
        quote_volume REAL,
        open_time INTEGER,
        close_time INTEGER,
        created_at TEXT
      );
      CREATE UNIQUE INDEX IF NOT EXISTS uniq_daily_scan ON daily_scan(scan_date, symbol);
      CREATE INDEX IF NOT EXISTS idx_daily_scan_dir ON daily_scan(scan_date, direction);
      CREATE INDEX IF NOT EXISTS idx_daily_scan_symbol ON daily_scan(symbol);

  - daily_features
      CREATE TABLE IF NOT EXISTS daily_features (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        scan_date TEXT NOT NULL,
        symbol TEXT NOT NULL,
        mark_price REAL,
        index_price REAL,
        last_funding_rate REAL,
        next_funding_time INTEGER,
        open_interest REAL,
        top_long_short_position_ratio REAL,
        top_long_short_account_ratio REAL,
        global_long_short_ratio REAL,
        taker_buy_sell_ratio REAL,
        basis REAL,
        annualized_basis_rate REAL,
        futures_price REAL,
        funding_rate_interval INTEGER,
        raw_json TEXT,
        created_at TEXT
      );
      CREATE UNIQUE INDEX IF NOT EXISTS uniq_daily_features ON daily_features(scan_date, symbol);
      CREATE INDEX IF NOT EXISTS idx_daily_features_symbol ON daily_features(symbol);
      CREATE INDEX IF NOT EXISTS idx_daily_features_date ON daily_features(scan_date);

  - feature_timeseries
      CREATE TABLE IF NOT EXISTS feature_timeseries (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        symbol TEXT NOT NULL,
        metric TEXT NOT NULL,
        timestamp INTEGER NOT NULL,
        value REAL NOT NULL,
        extra_json TEXT,
        created_at TEXT
      );
      CREATE UNIQUE INDEX IF NOT EXISTS uniq_feature_ts ON feature_timeseries(symbol, metric, timestamp);
      CREATE INDEX IF NOT EXISTS idx_feature_ts_metric ON feature_timeseries(symbol, metric);
      CREATE INDEX IF NOT EXISTS idx_feature_ts_time ON feature_timeseries(timestamp);

  - backtest_t1
      CREATE TABLE IF NOT EXISTS backtest_t1 (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        scan_date TEXT NOT NULL,
        symbol TEXT NOT NULL,
        direction TEXT NOT NULL,
        rank INTEGER NOT NULL,
        t1_open REAL,
        t1_close REAL,
        t1_return REAL,
        created_at TEXT
      );
      CREATE UNIQUE INDEX IF NOT EXISTS uniq_backtest_t1 ON backtest_t1(scan_date, symbol);
      CREATE INDEX IF NOT EXISTS idx_backtest_t1_date ON backtest_t1(scan_date);
      CREATE INDEX IF NOT EXISTS idx_backtest_t1_symbol ON backtest_t1(symbol);

  ———

  ## 十六、配置项建议（app.conf 或 env）

  - scan.enabled = true
  - scan.utc_hour = 0
  - scan.utc_minute = 5
  - scan.top_n = 10
  - scan.min_quote_volume = 50000000
  - scan.max_workers = 5
  - scan.retry_max = 4
  - scan.retry_backoff_ms = 800
  - scan.log_raw = false

  ———

  ## 十七、幂等写入与 Upsert 规则

  - daily_scan：按 (scan_date, symbol) Upsert（更新 rank / pct / volume）
  - daily_features：按 (scan_date, symbol) Upsert（更新所有快照字段）
  - feature_timeseries：按 (symbol, metric, timestamp) Ignore/Upsert
  - backtest_t1：按 (scan_date, symbol) Upsert（更新 t1_return）

  ———

  ## 十八、T+1 日K回测取数细节

  - 使用 UTC 日线 1d：startTime = scanDateUTC+24h, endTime = scanDateUTC+48h
  - 若返回多根 K线：只取当天 UTC 的那一根
  - t1_open = Kline.Open
  - t1_close = Kline.Close
  - t1_return = (t1_close / t1_open) - 1
  - 若 Kline 缺失（停牌/异常）：记录缺失并跳过

  ———

  ## 十九、数据质量校验规则

  - daily_scan：必须 20 条（10 涨 + 10 跌），不足则记录异常
  - daily_features：缺失字段 <= 3 个允许存（避免断流）
  - feature_timeseries：若历史接口返回 0，则回退一次重试
  - backtest_t1：若日K缺失，标记为缺失并保留 scan 记录

  ———

  ## 二十、日志与报警建议

  - 关键日志：scan_date / symbol / 接口耗时 / 失败原因 / 回退次数
  - 告警触发：
      - daily_scan < 20
      - backtest_t1 覆盖率 < 80%
      - 连续两天数据缺失

  ———

  ## 二十一、回测输出建议（报表字段）

  - scan_date
  - direction (gain/lose)
  - rank
  - t1_return
  - top/bottom 分位统计
  - 胜率、均值、中位数、p90/p10

  ———

  ## 二十二、后续扩展（可选）

  - 引入多周期回测（T+3 / T+7）
  - 增加“连续上榜次数”特征
  - 加入“波动率/ATR/成交额增速”派生特征
  - 加入“是否重大事件日（宏观数据/新闻）”标记
